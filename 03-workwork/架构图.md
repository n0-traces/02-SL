# NFT 拍卖市场架构图

## 🏗️ 系统整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                    NFT 拍卖市场系统                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │
│  │   NFT 合约  │    │  拍卖工厂   │    │  拍卖合约   │         │
│  │  (ERC721)   │◄──►│  (Factory)  │◄──►│  (Auction)  │         │
│  │             │    │             │    │             │         │
│  │ • 铸造 NFT  │    │ • 创建拍卖  │    │ • ETH 出价  │         │
│  │ • 转移 NFT  │    │ • 管理拍卖  │    │ • ERC20出价 │         │
│  │ • 跨链支持  │    │ • 价格预言机│    │ • 拍卖结算  │         │
│  └─────────────┘    └─────────────┘    └─────────────┘         │
│         │                   │                   │             │
│         │                   │                   │             │
│         ▼                   ▼                   ▼             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │
│  │ CCIP 跨链   │    │ Chainlink   │    │ UUPS 代理   │         │
│  │ 消息处理    │    │ 价格预言机  │    │ 升级机制    │         │
│  │             │    │             │    │             │         │
│  │ • 跨链拍卖  │    │ • ETH/USD   │    │ • 合约升级  │         │
│  │ • 消息验证  │    │ • LINK/USD  │    │ • 状态保持  │         │
│  │ • 安全机制  │    │ • 价格比较  │    │ • 权限控制  │         │
│  └─────────────┘    └─────────────┘    └─────────────┘         │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 🔄 数据流向图

```
用户操作流程：
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│ 铸造NFT │───►│ 创建拍卖│───►│ 用户出价│───►│ 拍卖结算│
└─────────┘    └─────────┘    └─────────┘    └─────────┘
     │              │              │              │
     ▼              ▼              ▼              ▼
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│ NFT合约 │    │ 工厂合约│    │ 拍卖合约│    │ 资金转移│
└─────────┘    └─────────┘    └─────────┘    └─────────┘
```

## 🏭 工厂模式架构

```
                    ┌─────────────────┐
                    │   AutionFactory │
                    │   (拍卖工厂)    │
                    └─────────────────┘
                             │
                             │ createAution()
                             ▼
        ┌─────────────────────────────────────────┐
        │                                         │
        ▼                                         ▼
┌─────────────┐                          ┌─────────────┐
│  Auction #1 │                          │  Auction #2 │
│             │                          │             │
│ • NFT A     │                          │ • NFT B     │
│ • 起拍价    │                          │ • 起拍价    │
│ • 出价者    │                          │ • 出价者    │
└─────────────┘                          └─────────────┘
        │                                         │
        ▼                                         ▼
┌─────────────┐                          ┌─────────────┐
│  Auction #3 │                          │  Auction #N │
│             │                          │             │
│ • NFT C     │                          │ • NFT N     │
│ • 起拍价    │                          │ • 起拍价    │
│ • 出价者    │                          │ • 出价者    │
└─────────────┘                          └─────────────┘
```

## 🔗 跨链架构

```
链 A (以太坊)                   链 B (Polygon)
┌─────────────┐                ┌─────────────┐
│   NFT 合约  │                │   NFT 合约  │
│             │                │             │
│ • 铸造 NFT  │                │ • 接收 NFT  │
│ • 跨链转移  │                │ • 跨链拍卖  │
└─────────────┘                └─────────────┘
        │                              │
        │ CCIP 消息                    │
        ▼                              ▼
┌─────────────┐                ┌─────────────┐
│ 消息处理器  │◄──────────────►│ 消息处理器  │
│             │                │             │
│ • 验证消息  │                │ • 验证消息  │
│ • 处理拍卖  │                │ • 处理拍卖  │
└─────────────┘                └─────────────┘
```

## 💰 价格预言机集成

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   ETH 价格  │    │  LINK 价格  │    │   USD 价格  │
│             │    │             │    │             │
│ $2,000      │    │ $15         │    │ $1          │
└─────────────┘    └─────────────┘    └─────────────┘
        │                   │                   │
        │ Chainlink         │ Chainlink         │
        │ 预言机            │ 预言机            │
        ▼                   ▼                   ▼
┌─────────────────────────────────────────────────────┐
│               价格比较系统                           │
│                                                     │
│ • 1 ETH = $2,000                                   │
│ • 100 LINK = $1,500                                │
│ • 比较: ETH 出价更高                               │
└─────────────────────────────────────────────────────┘
```

## 🔄 合约升级架构

```
                    ┌─────────────────┐
                    │   代理合约      │
                    │  (用户交互)     │
                    └─────────────────┘
                             │
                             │ 指向
                             ▼
        ┌─────────────────────────────────────────┐
        │                                         │
        ▼                                         ▼
┌─────────────┐                          ┌─────────────┐
│ 实现合约 V1 │                          │ 实现合约 V2 │
│             │                          │             │
│ • 基础功能  │                          │ • 新功能    │
│ • 旧逻辑    │                          │ • 优化逻辑  │
└─────────────┘                          └─────────────┘
        │                                         │
        │ 升级前                                  │ 升级后
        ▼                                         ▼
┌─────────────────────────────────────────────────────┐
│                存储数据                             │
│  (保持不变，只升级逻辑)                             │
└─────────────────────────────────────────────────────┘
```

## 🧪 测试架构

```
┌─────────────────────────────────────────────────────┐
│                   测试层                             │
├─────────────────────────────────────────────────────┤
│                                                     │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │
│  │  单元测试   │  │  集成测试   │  │  端到端测试 │  │
│  │             │  │             │  │             │  │
│  │ • NFT 功能  │  │ • 拍卖流程  │  │ • 完整流程  │  │
│  │ • 工厂功能  │  │ • 跨链功能  │  │ • 用户场景  │  │
│  │ • 价格计算  │  │ • 升级功能  │  │ • 边界情况  │  │
│  └─────────────┘  └─────────────┘  └─────────────┘  │
│         │                 │                 │       │
│         ▼                 ▼                 ▼       │
│  ┌─────────────────────────────────────────────────┐ │
│  │              合约层                              │ │
│  │  (被测试的智能合约)                              │ │
│  └─────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────┘
```

## 📁 文件结构图

```
NTFMarket/
├── 📁 contracts/                    # 智能合约源码
│   ├── 📄 NFT.sol                  # NFT 合约 (ERC721)
│   ├── 📄 AutionFactory.sol        # 拍卖工厂
│   ├── 📄 Aution.sol               # 拍卖合约
│   ├── 📄 NFTV2.sol                # NFT 升级版本
│   ├── 📄 CrossChainNFTAuction.sol # 跨链拍卖
│   ├── 📄 CrossChainNFTBridge.sol  # 跨链桥
│   ├── 📄 CrossChainMessageProcessor.sol # 消息处理器
│   ├── 📄 CCIPReceiverUpgradeable.sol    # CCIP 接收器
│   └── 📁 interfaces/              # 接口定义
│       └── 📄 IAutionFactory.sol   # 工厂接口
├── 📁 test/                        # 测试文件
│   ├── 📄 NFT.ts                   # NFT 测试
│   ├── 📄 Aution.ts                # 拍卖测试
│   ├── 📄 CrossChainNFT.ts         # 跨链测试
│   ├── 📄 CrossChainMsg.ts         # 消息测试
│   └── 📄 CrossChainBrige.ts       # 桥测试
├── 📁 deploy/                      # 部署脚本
│   ├── 📄 01_nft_uups_deploy.ts    # NFT 部署
│   ├── 📄 01_aution_factory_deploy.ts # 工厂部署
│   ├── 📄 02_nft_uups_deploy.ts    # 升级部署
│   └── 📄 deployCrossChain*.ts     # 跨链部署
├── 📁 utils/                       # 工具函数
│   ├── 📄 DelayTime.ts             # 时间工具
│   ├── 📄 proxyAddress.ts          # 代理地址管理
│   └── 📄 verify.ts                # 验证工具
├── 📁 typechain-types/             # TypeScript 类型
├── 📄 hardhat.config.ts            # Hardhat 配置
├── 📄 package.json                 # 项目依赖
└── 📄 README.md                    # 项目说明
```

## 🎯 学习路径可视化

```
第1阶段: 基础理解 (1-2天)
    ↓
📁 hardhat.config.ts → 📁 package.json → 📁 README.md
    ↓
第2阶段: 核心合约 (3-5天)
    ↓
📄 NFT.sol → 📄 AutionFactory.sol → 📄 Aution.sol
    ↓
第3阶段: 高级功能 (2-3天)
    ↓
📄 CrossChain*.sol → 📄 NFTV2.sol
    ↓
第4阶段: 测试部署 (2-3天)
    ↓
📁 test/ → 📁 deploy/ → 实践部署
```

## 🔧 技术栈图

```
┌─────────────────────────────────────────────────────┐
│                   技术栈                            │
├─────────────────────────────────────────────────────┤
│                                                     │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │
│  │  Solidity   │  │  Hardhat    │  │ TypeScript  │  │
│  │   0.8.28    │  │   框架      │  │   类型系统  │  │
│  └─────────────┘  └─────────────┘  └─────────────┘  │
│         │                 │                 │       │
│         ▼                 ▼                 ▼       │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │
│  │ OpenZeppelin│  │  Chainlink  │  │   Ethers.js │  │
│  │   库        │  │   预言机    │  │   交互库    │  │
│  └─────────────┘  └─────────────┘  └─────────────┘  │
│         │                 │                 │       │
│         ▼                 ▼                 ▼       │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │
│  │   ERC721    │  │    CCIP     │  │   UUPS      │  │
│  │   NFT标准   │  │   跨链协议  │  │   代理模式  │  │
│  └─────────────┘  └─────────────┘  └─────────────┘  │
└─────────────────────────────────────────────────────┘
```

这个架构图展示了整个 NFT 拍卖市场的设计思路和技术实现。建议按照学习指南中的路径，从简单到复杂逐步学习！ 🚀
